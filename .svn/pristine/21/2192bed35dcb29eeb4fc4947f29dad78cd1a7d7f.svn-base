package m.w.frs.mgserver.module;

import java.util.Iterator;
import java.util.List;

import m.w.core.dto.DataGrid;
import m.w.core.dto.Result;
import m.w.frs.mgserver.service.AgentService;
import m.w.frs.mgserver.service.snapup.OrderService;
import m.w.sys.domain.CommerceUser;
import m.w.sys.domain.CommerceUser.Role;
import m.w.sys.domain.CommerceUserAgentConfig;
import m.w.sys.service.CommerceUserService;

import org.nutz.dao.Cnd;
import org.nutz.ioc.loader.annotation.Inject;
import org.nutz.ioc.loader.annotation.IocBean;
import org.nutz.mvc.annotation.At;

@At("/agent")
@IocBean
public class AgentModule {

	@Inject
	private AgentService agentService;

	@Inject
	private CommerceUserService commerceUserService;

	@Inject
	private OrderService orderService;
	
	/**
	 * list order info
	 * */
	@At({ "/items" })
	public DataGrid items() {
		DataGrid dg = agentService.datagrid();
		List<CommerceUserAgentConfig> agents = (List<CommerceUserAgentConfig>) dg
				.getRows();
		for (Iterator iterator = agents.iterator(); iterator.hasNext();) {
			CommerceUserAgentConfig commerceUserAgentConfig = (CommerceUserAgentConfig) iterator
					.next();
			commerceUserAgentConfig = agentService.dao().fetchLinks(
					commerceUserAgentConfig, "commerceUser");
		}
		dg.setRows(agents);
		return dg;
	}

	@At({ "/save" })
	public Result save(Long agentId, float profitRatio) {
		CommerceUserAgentConfig config = agentService.fetch(Cnd.where(
				"agentId", "=", agentId));
		if (config != null) {
			config.setProfitRatio(profitRatio);
		} else {
			// insert
			config = new CommerceUserAgentConfig(agentId, profitRatio);
		}
		agentService.save(config);
		CommerceUser user = commerceUserService.fetch(agentId);
		user.setRole(Role.AGENT);
		commerceUserService.save(user);
		return Result.ok();
	}

	@At({ "/updateStutus" })
	public Result updateStutus(Long agentId,
			CommerceUserAgentConfig.Status status) {
		CommerceUserAgentConfig config = agentService.fetch(Cnd.where(
				"agentId", "=", agentId));
		if (config != null) {
			config.setStatus(status);
			agentService.save(config);
		}
		return Result.ok();
	}

	@At({ "/delete/?" })
	public Result delete(Long agentId) {
		agentService.dao().clear(CommerceUserAgentConfig.class,
				Cnd.where("agentId", "=", agentId));
		return Result.ok();
	}
}
